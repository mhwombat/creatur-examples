\documentclass[a4paper,10pt]{report}
\usepackage{xunicode}
\usepackage{xltxtra}
\usepackage{color}
\usepackage{enumerate}
\usepackage[top=1.5cm, bottom=1.5cm, left=1.5cm, right=1.5cm]{geometry}
\usepackage{url}

\usepackage{minted}
\definecolor{frame_color}{gray}{0.70}
\addtolength\fboxsep{0.2cm}
\usemintedstyle{trac}
\newminted[code]{haskell}{xleftmargin=1cm, samepage=true}

\usepackage{fancyvrb}
%\DefineVerbatimEnvironment{code}{Verbatim}{frame=single, framerule=0.5mm, fontsize=\small, formatcom=\color{blue}}
%\DefineVerbatimEnvironment{example}{Verbatim}{}
\DefineShortVerb{\|}

\newcommand{\includeSource}[1]{
  \inputminted[frame=single, rulecolor=\color{frame_color}]{haskell}{#1}
}

\newcommand{\includeHaskell}[3]{
  The source code for this section is contained in \path{#1}.
  \begin{listing}[H]
  \inputminted[frame=single, rulecolor=\color{frame_color}]{haskell}{#1}
  \caption{#3}
  \label{lst:{#2}}
  \end{listing}
}

\title{Créatúr Tutorial}
\author{Amy de Buitl\'eir\\
        Email: amy@nualeargais.ie}

\begin{document}

\maketitle

\tableofcontents

\chapter{Overview of Créatúr}

Créatúr\footnote{\emph{Créatúr} (pronounced kray-toor) is an irish word 
meaning animal, creature, or unfortunate person.} 
is a software framework for automating experiments
with artificial life (ALife). 
It provides a daemon which ensures that each agent gets its turn 
to use the CPU. 
You can use other applications on the computer at the same time
without fear of interfering with experiments; they
will run normally (although perhaps more slowly).
Créatúr also provides a library of modules to help you implement your own 
ALife species.
Even if you aren't using the Créatúr framework, you may find some of these
modules useful.

\chapter{The main daemon loop}
\label{sec:daemon}

The daemon clock is a simple counter used to schedule events.
At each tick of the clock, the daemon

\begin{enumerate}
\item Reads the current list of agents, which are stored as separate files in
the current directory.
\item Queues the agents in random order.
\item Processes the queue, giving each agent an opportunity
to use the CPU by invoking a user-supplied function.
\item Increments the daemon clock.
\end {enumerate}

A different random order is used at each clock tick
so that no agent has an unfair advantage.
For example, if agents were always processed in the same order, 
agents near the end of the list might find that that the desirable mating
partners are already taken.

\chapter{Overview of the process}

The steps for using Créatúr to create and run an ALife experiment
are listed below.

\begin{enumerate}
\item Create one or more ALife species
\item Generate an initial population
\item Configure a daemon
\item Build and run the universe
\end {enumerate}

All examples discussed in this tutorial are available from
\url{https://github.com/mhwombat/creatur/archive/master.zip}.

\chapter{Example 1: A very simple species}
\label{sec:rock}

In this part of the tutorial, we create and run a universe
with a very simple species.
This will introduce you to the basics of the Créatúr framework.

\section{Create a species}
\label{sec:species1}

\input{src/Tutorial/Example1/Rock.tex}

\section{Generate an initial population}
\label{sec:pop1}

\input{src/Tutorial/Example1/GeneratePopulation.tex}

The procedure for running this program will be described in Section 
\ref{sec:run1}.

\section{Configure a daemon}
\label{sec:daemon1}

\input{src/Tutorial/Example1/Daemon.tex}

\section{Build and run the example}
\label{sec:run1}


Here is the listing of |creatur-examples.cabal|.
\verbatiminput{creatur-examples.cabal}

\begin{enumerate}
\item Make sure you're in the directory containing |creatur-examples.cabal|.
\item Type |cabal install|.
\item Create the initial population by running |example1-init|.
\item Start the daemon with the command |sudo example1-daemon start|.
\item Stop the daemon with the command |sudo example1-daemon stop|.
(Stopping the daemon may take a few seconds.)
\end{enumerate}

Log messages are sent to |rocktopia/log/Rocktopia.log|.
Examine that file and notice that the counter is counting up for both rocks.
If you stop the daemon and restart it, it will pick up where it left off
\footnote{When the stop command is received, the daemon will attempt
to finish the processing for the current clock tick.
Depending on the processor speed and the number of agents in the population,
it may not finish before the hard kill which is issued three seconds later.
The database or file system is not updated until an agent's turn at the CPU 
is complete, so any partial results are discarded.
If the daemon terminates while an agent is running,
the effect is that the current agent, and all others after it in the queue,
miss their turn at the CPU.
However, even frequent restarting of the daemon
is unlikely to cause CPU starvation for any particular agent.
The random order in which agents are processed spreads the impact
over the population.}, preserving the value of the 
counter between runs.

A sample extract from the log file is shown below.
The first field is the system clock time.
The second field is the daemon clock time.
The third field is the log message.
Note that in clock tick |0|, |Rocky| gets to use the CPU before |Rocky|,
while in clock tick |3|, |Roxie| goes first.
This demonstrates the randomisation discussed in section \ref{sec:daemon}.

\begin{verbatim}
130121121233+0000       Starting
130121121233+0000       0       Rocky's counter is 42
130121121233+0000       0       Roxie's counter is 99
130121121233+0000       1       Rocky's counter is 43
130121121233+0000       1       Roxie's counter is 100
130121121233+0000       2       Roxie's counter is 101
130121121233+0000       2       Rocky's counter is 44
130121121233+0000       3       Roxie's counter is 102
130121121233+0000       3       Rocky's counter is 45
130121121234+0000       4       Rocky's counter is 46
130121121234+0000       4       Roxie's counter is 103
\end{verbatim}

\chapter{Recombination}
\label{sec:recombination}

When agents that reproduce, the offspring will inherit a mixture of
genetic information from both parents.
Here are two scenarios that could be used, although there are other
possibilities.

\begin{enumerate}
\item Your agents use \emph{asexual} reproduction.
Each agent has a \emph{single} sequence of genetic information.
When two agents mate, their genes are shuffled to produce
two \emph{new} sequences.
You can create two children from these sequences,
or discard one sequence and create a child with the remaining sequence.
\item Your agents use \emph{sexual} reproduction.
Each agent has \emph{two} sequences of genetic information.
When two agents mate, each agent contributes \emph{one}
sequence to the child.
A parent's two sequences are shuffled to produce two \emph{new}
sequences.
One of the sequences is discarded; the other sequence becomes
that parent's contribution to the child's genome.
The same process occurs with the other parent's genome.
The two sequences (one from each parent) are combined to create the 
child's genome.
This is analogous to the production of a \emph{gamete} (ovum or sperm) 
in biology.
\end{enumerate}

Both scenarios involve shuffling a pair of sequences to produce two new
pairs, and possibly discarding one of the sequences.
In addition, you may wish to allow occasional random mutations.
The Créatúr framework provides the 
several operations for this purpose, in the
\path{ALife.Creatur.Genetics.Recombination} package.
These operations can be applied (multiple times)
with specified probabilities
and combined in various ways.
Two common operations, \emph{crossover} and \emph{cut-and-splice},
are illustrated below.
In crossover, a single crossover point is chosen.
All data beyond that point is swapped between strings.
In cut-and-splice, two points are chosen, one on each string.
This generally results in two strings of unequal length.

\begin{figure}[hbtp]
 \centering
 \includegraphics[scale=0.7,keepaspectratio=true]{./images/crossover.eps}
  \caption{Crossover}
  \label{fig:crossover}
\end{figure}

\begin{figure}[hbtp]
 \centering
 \includegraphics[scale=0.7,keepaspectratio=true]{./images/cut-and-splice.eps}
  \caption{Cut-and-splice}
  \label{fig:cut-and-splice}
\end{figure}

Here's a sample program that might be used to shuffle two
sequences of genetic material.

\label{code:recombination}
\begin{code}
    withProbability 0.1 randomCrossover (xs, ys) >>=
    withProbability 0.01 randomCutAndSplice >>=
    withProbability 0.001 mutatePairedLists >>=
    randomOneOfPair
\end{code} 

To understand how this program works,
let's walk through a simple example.
Suppose this program acted on the following pair of sequences:
|([A,A,A,A,A,A,A,A,A,A],[C,C,C,C,C,C,C,C,C,C])|.
The first line \emph{might} perform a simple crossover,
perhaps resulting in  |([A,A,A,A,A,A,A,C,C,C],[C,C,C,C,C,C,C,A,A,A])|.
The second line \emph{might} then perform a cut-and-splice, perhaps
resulting in |([A,A,A,A,C,A,A,A],[C,C,C,C,C,C,A,A,A,C,C,C])|.
The third line \emph{might} then mutate one or both sequences, perhaps
resulting in |([T,A,A,A,C,A,A,A],[C,C,C,C,C,C,A,A,C,C,C,C])|.
The numbers 0.1, 0.01, and 0.001 control the likelihood of each
of the three operations occurring.
After the first three operations, we have two new sequences.
In this example, we only want one of the sequences,
so the final line randomly chooses one.

To perform more than one crossover, the operation can simply be repeated
as shown below.

\begin{code}
    withProbability 0.1 randomCrossover (xs, ys) >>=
    withProbability 0.08 randomCrossover (xs, ys) >>=
    . . .
\end{code} 

Alternatively, we can choose the number of crossover operations at 
random. The function |repeatWithProbability| performs an operation a
random number of times, such that the probability of repeating the
operation |n| times is $p^n$.

\begin{code}
    repeatWithProbability 0.1 randomCrossover (xs, ys) >>=
    . . .
\end{code} 

Other recombination operators are also available.
Consult the documentation of \path{ALife.Creatur.Genetics.Recombination}
for more information.

\chapter{Example 2: Asexual reproduction}
\label{sec:plant}

In this part of the tutorial, we create a species with the
ability to reproduce asexually.

\section{Create a species}
\label{sec:species2}

\input{src/Tutorial/Example2/Plant.tex}

\section{Generate an initial population}
\label{sec:pop2}

\input{src/Tutorial/Example2/GeneratePopulation.tex}

\section{Configure a daemon}
\label{sec:daemon2}

\input{src/Tutorial/Example2/Daemon.tex}

\section{Build and run the example}
\label{sec:run2}

\begin{enumerate}
\item Make sure you're in the directory containing |creatur-examples.cabal|.
\item Type |cabal install| (if you haven't already done so).
\item Create the initial population by running |example2-init|.
\item Start/stop/restart the daemon with the command
\UndefineShortVerb{\|}
\DefineShortVerb{\+}
+sudo example2-daemon start|stop|restart+.
\UndefineShortVerb{\+}
\DefineShortVerb{\|}
(Stopping the daemon may take a few seconds.)
\end{enumerate}

Log messages are sent to |example2/log/Example2.log|.

A sample extract from the log file is shown below.
To conserve space, the timestamps have been omitted.
From this, you can see that the first mating (between |Rose| and |Sunny|)
occurs at time 0.
The offspring, |Example2_1|, gets its first CPU turn at time 1.

\begin{verbatim}
Starting
0       Vi and Rose gave birth to Example2_1, with Red flowers
0       Rose and Vi gave birth to Example2_2, with Violet flowers
0       Sunny and Rose gave birth to Example2_3, with Red flowers
1       Example2_1 and Sunny gave birth to Example2_4, with Yellow flowers
1       Rose and Vi gave birth to Example2_5, with Violet flowers
1       Example2_3 and Example2_2 gave birth to Example2_6, with Red flowers
1       Example2_2 and Sunny gave birth to Example2_7, with Violet flowers
1       Vi and Example2_7 gave birth to Example2_8, with Violet flowers
1       Sunny and Example2_8 gave birth to Example2_9, with Yellow flowers
2       Example2_4 and Rose gave birth to Example2_10, with Yellow flowers
2       Example2_7 and Example2_6 gave birth to Example2_11, with Violet flowers
2       Example2_6 and Rose gave birth to Example2_12, with Red flowers
2       Example2_5 and Example2_10 gave birth to Example2_13, with Violet flowers
2       Example2_3 and Example2_7 gave birth to Example2_14, with Red flowers
2       Example2_8 and Example2_14 gave birth to Example2_15, with Red flowers
2       Rose and Example2_14 gave birth to Example2_16, with Red flowers
2       Sunny and Example2_12 gave birth to Example2_17, with Yellow flowers
2       Vi and Example2_5 gave birth to Example2_18, with Violet flowers
\end{verbatim}

\chapter{Example 3: Sexual reproduction}
\label{sec:bug}

In this part of the tutorial, we create a species with the
ability to reproduce sexually.

\section{Create a species}
\label{sec:species3}

\input{src/Tutorial/Example3/Bug.tex}

\section{Generate an initial population}
\label{sec:pop3}

\input{src/Tutorial/Example3/GeneratePopulation.tex}

\section{Configure a daemon}
\label{sec:daemon3}

\input{src/Tutorial/Example3/Daemon.tex}

\section{Build and run the example}
\label{sec:run3}

\begin{enumerate}
\item Make sure you're in the directory containing |creatur-examples.cabal|.
\item Type |cabal install| (if you haven't already done so).
\item Create the initial population by running |example3-init|.
\item Start/stop/restart the daemon with the command
\UndefineShortVerb{\|}
\DefineShortVerb{\+}
+sudo example3-daemon start|stop|restart+.
\UndefineShortVerb{\+}
\DefineShortVerb{\|}
(Stopping the daemon may take a few seconds.)
\end{enumerate}

Log messages are sent to |example3/log/Example3.log|.

A sample extract from the log file is shown below.

\begin{verbatim}
130121134119+0000       Starting
130121134119+0000       0       Zelda just woke up. Energy=10
130121134119+0000       0       Zelda sees Mel
130121134119+0000       0       Zelda mated with Mel.
130121134119+0000       0       Zelda and Mel gave birth to Example3_1, a Green Male bug
130121134119+0000       0       Zelda is going back to sleep. Energy=9
130121134119+0000       0       Mel just woke up. Energy=10
130121134119+0000       0       Mel is going back to sleep. Energy=9
130121134119+0000       0       Betty just woke up. Energy=10
130121134119+0000       0       Betty sees Bugsy
130121134119+0000       0       Betty mated with Bugsy.
130121134119+0000       0       Betty and Bugsy gave birth to Example3_2, a Green Male bug
130121134119+0000       0       Betty is going back to sleep. Energy=9
130121134119+0000       0       Bugsy just woke up. Energy=10
130121134119+0000       0       Bugsy is going back to sleep. Energy=9
130121134119+0000       1       Mel just woke up. Energy=9
130121134119+0000       1       Mel is going back to sleep. Energy=8
130121134119+0000       1       Zelda just woke up. Energy=9
130121134119+0000       1       Zelda sees Example3_1
130121134119+0000       1       Zelda mated with Example3_1.
130121134119+0000       1       Zelda and Example3_1 gave birth to Example3_3, a Green Male bug
130121134119+0000       1       Zelda is going back to sleep. Energy=8
130121134119+0000       1       Betty just woke up. Energy=9
130121134119+0000       1       Betty sees Zelda
130121134119+0000       1       Betty is not interested in Zelda.
130121134119+0000       1       Betty is going back to sleep. Energy=8
130121134119+0000       1       Example3_1 just woke up. Energy=10
130121134119+0000       1       Example3_1 is going back to sleep. Energy=9
130121134119+0000       1       Example3_2 just woke up. Energy=10
130121134119+0000       1       Example3_2 is going back to sleep. Energy=9
130121134119+0000       1       Bugsy just woke up. Energy=9
130121134119+0000       1       Bugsy is going back to sleep. Energy=8
130121134120+0000       2       Example3_1 just woke up. Energy=9
130121134120+0000       2       Example3_1 is going back to sleep. Energy=8
130121134120+0000       2       Bugsy just woke up. Energy=8
130121134120+0000       2       Bugsy is going back to sleep. Energy=7
\end{verbatim}

\chapter{Example 4: Working with multiple species}
\label{sec:multiple}

In this part of the tutorial, we a universe with multiple species,
where each species is a different Haskell type.

\section{Create a species}
\label{sec:species4}

\input{src/Tutorial/Example4/Rock.tex}
\input{src/Tutorial/Example4/Plant.tex}
\input{src/Tutorial/Example4/Bug.tex}

\section{Generate an initial population}
\label{sec:pop4}

\input{src/Tutorial/Example4/GeneratePopulation.tex}

\section{Configure a daemon}
\label{sec:daemon4}

\input{src/Tutorial/Example4/Daemon.tex}

\section{Build and run the example}
\label{sec:run4}

\begin{enumerate}
\item Make sure you're in the directory containing |creatur-examples.cabal|.
\item Type |cabal install| (if you haven't already done so).
\item Create the initial population by running |example4-init|.
\item Start/stop/restart the daemon with the command
\UndefineShortVerb{\|}
\DefineShortVerb{\+}
+sudo example4-daemon start|stop|restart+.
\UndefineShortVerb{\+}
\DefineShortVerb{\|}
(Stopping the daemon may take a few seconds.)
\end{enumerate}

Log messages are sent to |example4/log/Example4.log|.

\chapter{TO DO}
\begin{enumerate}
\item Explain that if you don't want the child to be immediately mature,
you could have it be a field in the mother's implementation.

\item Show how to collect statistics.

\item Show how to keep agents and logs in a database rather than as separate
files. I'm thinking of providing an "agent interface" to MongoDB and any
ODBC-compliant DB.

\item Show how to get a list of agents meeting certain criteria 
(e.g. all agents within a certain distance of a particular agent).
This will require a different DB.

\item Show how to add other state data to the universe (in addition to
the clock, logger, agent namer, and database).
\end{enumerate}

\end{document}
